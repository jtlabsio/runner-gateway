# runner-gateway

A simple gateway for interacting with model runner APIs (i.e. Ollama) that provides TLS and OAuth2.0 authentication with PASETO token validation.

## Features

- **Authentication**: Secure access to the Ollama API using PASETO tokens.
- **Configuration**: Easy configuration through a YAML file.
- **Logging**: Detailed logging for monitoring and debugging.
- **SSL/TLS Support**: SSL/TLS support for secure communication.

## How It Works

The runner-gateway acts as a bridge between your application and the Ollama API. It handles authentication, logging, and SSL/TLS encryption to ensure secure communication. There are tools within the code base that can be used to generate PASETO tokens and validate them, but the server can also be configured to validate public or internal v4 PASETO tokens generated by other services.

### PASETO Token Validation

For more information on PASETO token validation and usage, refer to the [PASETO documentation](https://github.com/paseto-standard/paseto).

By default, the service is configured to validate v4 PASETO tokens. The service can support v2 and v4 PASETO tokens generated by other services with an adjustment to the settings.

## Installation

Clone the repository and run the following commands to install dependencies and build the project:

```bash
git clone https://github.com/jtlabsio/runner-gateway.git
cd runner-gateway
```

Next, configure the service...

### Configuration

#### PASETO Token Generation and Validation

Generate a PASETO v4 asymmetric key pair:

```bash
go run tools/paseto -action=asymmetric
```

This will generate `paseto.key` and `paseto.pub` files in the `./settings` directory (this is what the server is configured to look at by default).

**Note**: If you have an existing private / public key pair, you can use your existing public key for validation instead by adjusting the configuration accordingly. The private key is only used for generating tokens via the tools provided, but it is not required for runtime gateway operation.

#### Create a Custom Settings File

Within the `./settings` folder, create a custom settings file with the suffix of `.yaml`. For example, `my-domain.yaml`:

```yaml
logging:
  # override the logging level if desired (trace, debug, info, warn, error)
  level: info 
paseto:
  # if using the server to generate long living access tokens, the expiration can be overridden
  expiration: 8766h # 1 year
  # set your secret key here (optional if the service should validate v4.local tokens)
  secretKey: Xthisshouldbeasecretkeythatis64bytestosupportpasetov4standardsXX
server:
  # paths to your TLS certificate and keys (optional if TLS is desired)
  certificatePath: /home/user/.acme.sh/my-domain.com_ecc/my-domain.com.cer
  keyPath: /home/user/.acme.sh/my-domain.com_ecc/my-domain.com.key
```

**note:** A simple way to generate TLS certificates and keys is to use the `acme.sh` script. This script can be used to automate the creation and renewal of Let's Encrypt TLS certificates for your domain: <https://github.com/acmesh-official/acme.sh>

### Build

Once the configuration is set, the service can be built as a docker image:

```bash
make docker
```

#### Running

Replace the `GO_ENV` environment variable below with the name of the configuration file created above.

```bash
docker run -d \
  -p 8443:8443 \
  --add-host=host.docker.internal:host-gateway \
  --restart unless-stopped \
  --name runner-gateway \
  -e GO_ENV=my-domain \
  runner-gateway
```

## Tools

The following tools are available for generating and working with PASETO tokens:

### Generate Asymmetric (Private/Public) Key Pair

```bash
GO_ENV=my-domain go run tools/paseto -action=asymmetric
```

### Generate Symmetric Key

```bash
GO_ENV=my-domain go run tools/paseto -action=symmetric
```

### Generate Private PASETO Token Signed by Public Key

```bash
GO_ENV=my-domain go run tools/paseto -action=private
```

### Generate Public PASETO Token Signed by Public Key

```bash
GO_ENV=my-domain go run tools/paseto -action=public
```
